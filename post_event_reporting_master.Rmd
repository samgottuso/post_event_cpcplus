---
title: "Post_Event_Report"
author: "Sam Gottuso"
date: "December 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(ggplot2)
library(dplyr)
library(knitr)
library(rmarkdown)
library(readr)
library(reshape2)


##Load in functions necessary for creating DFs

#Figures out the mode of dates to determine what the correct date is
Mode_manual <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}


#standardization of which columns/names of columns
column_names_adobe<-c("First_name","Last_name","Email","Status","Login","Logoff","Duration","Role","Role_other","Organization_name","ID","Region","Zip")
  
column_numbers_adobe<-c(3,4,5,7,8,9,10,12,13,16,18,21,23)

column_names_webx<-column_names_adobe
column_numbers_webx<-c(1,2,3,10,11,12,19,33,34,37,43,41,51)

column_numbers_sm<-seq(10,18)
column_names_sm<-c("Track","Reported_role","Reported_role_other","Valuable_use_time","Connect_others","Take_action","Enhanced_knowledge","Suggestions","Technical_difficulties")



##Test data


#PIA2

PIA_2_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA2_analysis.xlsx',sheet = 2)


PIA_2_survey_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA_2_survey.xlsx',sheet = 1)



#ecqm_HIT_Review

eCQM_HIT_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/eCQM_HIT_analysis.xlsx',sheet = 1)

ecqm_HIT_survey<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/eCQM_HIT_Survey.xlsx', sheet = 1)

#what you need to know about financial reporting

need_to_know_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/need_to_know_analysis.xlsx',sheet = 1) 

need_to_know_survey<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/need_to_know_survey.xlsx',sheet = 1)


#PIA3

PIA_3_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA3_analysis.xlsx',sheet = 2)


PIA_3_survey_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA_3_survey.xlsx',sheet = 1)


#PIA4

PIA_4_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA4_BHI_CM_analysis.xlsx',sheet = 1)


PIA_4_survey_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA4_BHI_CM_Survey.xlsx',sheet = 1)


#PIA5

PIA_5_first_import<--read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA5_BHI_Behaviorist_analysis.xlsx',sheet = 1)

PIA_5_survey_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/PIA5_BHI_Behaviorist_Survey.xlsx',sheet = 1)

#Taking the Next Step Webinar

Taking_next_step_first_import<--read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/taking_next_step_analysis.xlsx',sheet = 1)

Taking_next_step_survey_first_import<-read_excel(path='C:/Users/583185/Desktop/data_science/post_event_reporting/Taking_next_step_Survey.xlsx',sheet = 1)


##Automatically clean and spit out necessary data 

event_meta_data<-data.frame(matrix(NA,ncol=26))
colnames(event_meta_data)<-c("Date","Event_name","Event Type","Attendance","Attendance_rate","Practice_attendees","Administration","Clinicians","Care_managers","Data_analyst","Project_managers","Project_director","Quality_improvement","CMS","Contractors","Payers","Vendors","Unique_practices","Total_practices","Survey_response_rate","Positive_VUT","Neutral_VUT","Negative_VUT","Positive_TA","Netural_TA","Negative_TA")

Event_data_cleaner<-function(type,event_name,event_type,imported_data,imported_survey_data){
  if(type=="adobe"){
    cleaned_data<-imported_data[,column_numbers_adobe]
    colnames(cleaned_data)<-column_names_adobe
  }else if(type=="webx"){
    cleaned_data<-imported_data[,column_numbers_webx]
    colnames(cleaned_data)<-column_names_webx
  }
  
  cleaned_data<-as.data.frame(cleaned_data)
  
  #Adding date
  date<-Mode_manual(na.omit(cleaned_data$Login))

  #Adding Attendance and attendance rate
  attendance<-(sum(cleaned_data$Status=="Attended",na.rm = TRUE))
  attendance_rate<-(attendance)/length(cleaned_data$Status)

  #Adding practice participants-- from attended only
  attended_df<-cleaned_data[(cleaned_data$Status=="Attended"),]
  admin<-sum(attended_df$Role=="Administration",na.rm = TRUE)
  drs<-sum(attended_df$Role=="Clinicians providing healthcare services within context of model",na.rm = TRUE)
  cm<-sum(attended_df$Role=="Care Manager",na.rm = TRUE)
  da<-sum(attended_df$Role=="Data Analysts",na.rm = TRUE)
  pm<-sum(attended_df$Role=="Project Manager/Coordinator",na.rm = TRUE)
  pd<-sum(attended_df$Role=="Project Director/Principal Investigator",na.rm = TRUE)
  qi<-sum(attended_df$Role=="Quality Improvement Director",na.rm = TRUE)
  PA<-sum(admin,drs,cm,da,pm,pd,qi)
  
  #Adding non-practice attendees
  cms<-sum(attended_df$Role=="CMS",na.rm = TRUE)
  cnt<-sum(attended_df$Role=="Contractor",na.rm = TRUE)
  pay<-sum(attended_df$Role_other=="Payer",na.rm = TRUE)
  ven<-sum(attended_df$Role_other=="Vendor",na.rm = TRUE)
  
  #Practices
  up=length(unique(attended_df$ID))
  tp=sum(attended_df$ID!="Not Available",na.rm = TRUE)
  
  
  ##Survey Stuff
  cleaned_data_survey<-imported_survey_data[,column_numbers_sm]
  colnames(cleaned_data_survey)<-column_names_sm
  
  cleaned_data_survey<-tail(cleaned_data_survey,-1)
  cleaned_data_survey<-cleaned_data_survey[rowSums(is.na(cleaned_data_survey))!=ncol(cleaned_data_survey),]
  
  cleaned_data_survey<-as.data.frame(cleaned_data_survey)
  
  srr<-(length(cleaned_data_survey$Track)/attendance)
  
  cleaned_data_survey$VUT<-parse_number(cleaned_data_survey$Valuable_use_time)
  cleaned_data_survey$TA<-parse_number(cleaned_data_survey$Take_action)
  
  p_vut<-sum(cleaned_data_survey$VUT==1)+sum(cleaned_data_survey$VUT==2)
  nu_vut<-sum(cleaned_data_survey$VUT==3)
  n_vut<-sum(cleaned_data_survey$VUT==4)+sum(cleaned_data_survey$VUT==5)
  
  p_TA<-sum(cleaned_data_survey$TA==1)+sum(cleaned_data_survey$TA==2)
  nu_TA<-sum(cleaned_data_survey$TA==3)
  n_TA<-sum(cleaned_data_survey$TA==4)+sum(cleaned_data_survey$TA==5)
  
  
  TD<-sum(cleaned_data_survey$Technical_difficulties=="Yes")
  
  
  
#append it onto the end of our event meta data frame which we will use to create all of graphs. 

append_list<-c(date,event_name,event_type,attendance,attendance_rate,PA,admin,drs,cm,da,pm,pd,qi,cms,cnt,pay,ven,up,tp,srr,p_vut,nu_vut,n_vut,p_TA,nu_TA,n_TA,TD)

event_meta_data<-rbind(event_meta_data,append_list)

return(event_meta_data)
  
}

event_meta_data<-Event_data_cleaner("adobe","PIA2","PIA",PIA_2_first_import,PIA_2_survey_first_import)
event_meta_data<-Event_data_cleaner("webx","eCQM HIT Review","National Webinar",eCQM_HIT_first_import,ecqm_HIT_survey)
event_meta_data<-Event_data_cleaner("webx","What you need to know Financial Reporting","National Webinar",need_to_know_first_import,need_to_know_survey)
event_meta_data<-Event_data_cleaner("adobe","PIA 3: Risk Stratification","PIA",PIA_3_first_import,PIA_3_survey_first_import)

#Seperate these 3 events into seperate dataframes for ease of use.

last_event<-as.data.frame(tail(event_meta_data,1))
previous_event<-as.data.frame(head(tail(event_meta_data,2),1))


comparison<-rbind(previous_event,last_event)

#finding events with same type
last_events_type<-event_meta_data[event_meta_data$`Event Type`==last_event$`Event Type`,]

previous_event_same_type<-as.data.frame(head(tail(last_events_type,2),1))

comparison_same_type<-rbind(previous_event_same_type,last_event)

comparison_same_type$percentage_practices<-(as.numeric(comparison_same_type$Practice_attendees)/as.numeric(comparison_same_type$Attendance))

#averages and differences for same types of events
average_attendance_type<-mean(as.numeric(last_events_type$Attendance), na.rm=TRUE)

average_survey_response_rate_type<-mean(as.numeric(last_events_type$Survey_response_rate), na.rm=TRUE)

average_practices_type<-mean(as.numeric(last_events_type$Total_practices), na.rm=TRUE)

dif_attendance_type<-as.numeric(last_event$Attendance)-average_attendance_type

dif_survey_response_rate<-as.numeric(last_event$Survey_response_rate)-average_survey_response_rate_type

dif_practices<-as.numeric(last_event$Total_practices)-average_practices_type


##variables for our inline text

attendance_word<-ifelse(dif_attendance_type>0,"higher",ifelse(dif_attendance_type<0,"lower","same"))

survey_response_rate_word<-ifelse(dif_survey_response_rate>0,"higher",ifelse(dif_survey_response_rate<0,"lower","same"))

practices_word<-ifelse(dif_practices>0,"higher",ifelse(dif_practices<0,"lower","same"))


```

##Intro

This is a (mostly) automated post-event report that tells a story with our data, and compares to other recent and similar events so that everything we present to the client is viewed in context. It will also help us benchmark our performances in Program Year 2 as we look to build upon the success that we experienced during the first year of CPC+.

## Last Event

This section looks at `r last_event$Event_name` which took place on `r as.Date.POSIXct(as.numeric(last_event$Date))`. It had `r last_event$Attendance` attendees with `r round(as.numeric(last_event$Attendance_rate)*100,digits=1) `% of registrants attending. 


There were `r sum(as.numeric(last_event$Positive_VUT),as.numeric(last_event$Negative_VUT),as.numeric(last_event$Neutral_VUT))` respondents to the survey. This first graph shows how they responded to the "Valuable Use of Time" (VUT) and  "I will take Action" (TA) questions on the survey.

```{r, echo= FALSE}
melted_last_event<-melt(last_event,id.vars = "Event_name")
survey_colors<-c("green","yellow","red","green","yellow","red")
survey_barplot<-ggplot(melted_last_event[20:25,],aes(variable,value,fill=variable))+geom_bar(stat = 'identity')+scale_fill_manual(values = survey_colors)
survey_barplot

```


##Previous Event Comparision

This section reviews the differences between `r last_event$Event_name` and the previous `r last_event$'Event Type' `, which was titled `r comparison_same_type$Event_name[1] ` and took place on `r as.Date.POSIXct(as.numeric(comparison_same_type$Date[1])) `.

```{r,echo=FALSE}


melted_comparison<-melt(comparison_same_type,id.vars="Event_name")



attendance_barplot<-ggplot(melted_comparison[5:6,],aes(x=variable,y=as.numeric(value),fill=Event_name))+geom_bar(stat='identity', position = 'dodge')


attendance_barplot


```



This shows the distribution of attending roles for each event. 
```{r, echo=FALSE}

role_barplot<-ggplot(melted_comparison[11:32,],aes(x=variable,y=as.numeric(value),fill=Event_name))+geom_bar(stat = 'identity',position = 'dodge')+theme(axis.text.x = element_text(angle = 90, hjust = 1))+scale_y_continuous(breaks = seq(0,60,5))

role_barplot



```



##Same Type Comparison

This event had a `r attendance_word` attendance than the average attendance for this type of event and a `r practices_word` number of practices attend compared to the average. For the survey, it had a `r survey_response_rate_word` rate of response compared to other similar type events.

These graphs compare the last event to all of the other events of the same type.

```{r, echo=FALSE}




```
